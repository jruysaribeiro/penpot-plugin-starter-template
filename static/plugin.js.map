{"version":3,"file":"plugin.js","sources":["../src/plugin.ts"],"sourcesContent":["penpot.ui.open(\"Penpot AI Designer\", \"http://localhost:5173/index.html\", {\n  width: 440,\n  height: 600,\n});\n\n// Function to extract context from selected elements\nfunction getSelectionContext(): {\n  context: string;\n  width: number;\n  height: number;\n  svg: string;\n} {\n  const selection = penpot.selection;\n\n  if (!selection || selection.length === 0) {\n    return { context: \"\", width: 500, height: 500, svg: \"\" };\n  }\n\n  const colors = new Set<string>();\n  const shapes: string[] = [];\n  let hasText = false;\n  let hasFills = false;\n  let hasStrokes = false;\n  let strokeCount = 0;\n  let fillCount = 0;\n  let minX = Infinity,\n    minY = Infinity,\n    maxX = -Infinity,\n    maxY = -Infinity;\n\n  selection.forEach((shape) => {\n    // Calculate bounding box\n    if (\n      shape.x !== undefined &&\n      shape.y !== undefined &&\n      shape.width &&\n      shape.height\n    ) {\n      minX = Math.min(minX, shape.x);\n      minY = Math.min(minY, shape.y);\n      maxX = Math.max(maxX, shape.x + shape.width);\n      maxY = Math.max(maxY, shape.y + shape.height);\n    }\n\n    // Collect colors and analyze style\n    if (shape.fills && Array.isArray(shape.fills)) {\n      shape.fills.forEach((fill: any) => {\n        if (fill.fillColor) {\n          colors.add(fill.fillColor);\n          hasFills = true;\n          fillCount++;\n        }\n      });\n    }\n    if (shape.strokes && Array.isArray(shape.strokes)) {\n      shape.strokes.forEach((stroke: any) => {\n        if (stroke.strokeColor) {\n          colors.add(stroke.strokeColor);\n          hasStrokes = true;\n          strokeCount++;\n        }\n      });\n    }\n\n    // Identify shape types\n    if (shape.type === \"text\") {\n      hasText = true;\n    } else if (shape.type === \"rectangle\") {\n      shapes.push(\"rectangles\");\n    } else if (shape.type === \"ellipse\") {\n      shapes.push(\"circles/ellipses\");\n    } else if (shape.type === \"path\") {\n      shapes.push(\"custom paths\");\n    }\n  });\n\n  let context = \"\";\n  const hasSelection = selection.length > 0;\n\n  console.log(\"Selection analysis:\", {\n    selectionCount: selection.length,\n    hasStrokes,\n    hasFills,\n    strokeCount,\n    fillCount,\n    colorsFound: colors.size,\n    shapesFound: shapes.length,\n  });\n\n  // Determine visual style based on fills vs strokes\n  if (hasSelection) {\n    if (hasStrokes && !hasFills) {\n      context +=\n        \"IMPORTANT STYLE: Create a SIMPLE LINE DRAWING with outlines only, NO FILLS. Use minimalist line art style. \";\n    } else if (!hasStrokes && hasFills) {\n      context += \"STYLE: Use solid filled shapes without outlines. \";\n    } else if (strokeCount > fillCount * 2) {\n      context +=\n        \"IMPORTANT STYLE: Emphasize line work and outlines over fills. Keep it minimal. \";\n    } else if (!hasStrokes && !hasFills && shapes.length > 0) {\n      // Paths without detected fills/strokes - likely line art\n      context +=\n        \"IMPORTANT STYLE: Create a SIMPLE LINE DRAWING with clean outlines. Use minimalist line art style with NO FILLS. \";\n    }\n  }\n\n  if (colors.size > 0) {\n    context += `Use these colors: ${Array.from(colors).join(\", \")}. `;\n  }\n\n  if (shapes.length > 0) {\n    context += `Incorporate similar shapes like ${[...new Set(shapes)].join(\", \")}. `;\n  }\n\n  if (hasText) {\n    context += `Include text elements in the design. `;\n  }\n\n  // If we have a selection but no specific context, add a generic note\n  if (hasSelection && !context) {\n    context = `${selection.length} element${selection.length > 1 ? \"s\" : \"\"} selected. `;\n  }\n\n  // Calculate dimensions from bounding box\n  const width = maxX > minX ? Math.round(maxX - minX) : 500;\n  const height = maxY > minY ? Math.round(maxY - minY) : 500;\n\n  // Export selection as SVG - TODO: Find correct Penpot API for SVG export\n  let svg = \"\";\n  // For now, we'll add this feature later when we find the right API\n  // The checkbox will still appear based on context\n\n  return { context, width, height, svg };\n}\n\n// Send selection context when it changes\npenpot.on(\"selectionchange\", () => {\n  const { context, width, height, svg } = getSelectionContext();\n  penpot.ui.sendMessage({\n    source: \"penpot\",\n    type: \"selection-context\",\n    context,\n    width,\n    height,\n    svg,\n  });\n});\n\n// Send initial selection context\nsetTimeout(() => {\n  const { context, width, height, svg } = getSelectionContext();\n  penpot.ui.sendMessage({\n    source: \"penpot\",\n    type: \"selection-context\",\n    context,\n    width,\n    height,\n    svg,\n  });\n}, 100);\n\ninterface PluginMessage {\n  type:\n    | \"import-svg\"\n    | \"insert-svg\"\n    | \"import-pdf-page\"\n    | \"get-selected-text\"\n    | \"replace-text\"\n    | \"get-selected-image\"\n    | \"upload-cropped-image\"\n    | \"get-image-for-bg-removal\"\n    | \"upload-bg-removed-image\";\n  svg?: string;\n  content?: string;\n  offsetX?: number;\n  data?: ArrayBuffer;\n  pageNum?: number;\n  width?: number;\n  height?: number;\n  text?: string;\n  imageData?: number[];\n  originalX?: number;\n  originalY?: number;\n}\n\npenpot.ui.onMessage<PluginMessage>(async (message) => {\n  if (message.type === \"import-svg\" || message.type === \"insert-svg\") {\n    try {\n      const svgContent = message.svg || message.content;\n      if (!svgContent) {\n        throw new Error(\"No SVG content provided\");\n      }\n\n      // Create SVG shape in Penpot\n      const svgShape = penpot.createShapeFromSvg(svgContent);\n\n      if (svgShape) {\n        // Position in viewport center with optional horizontal offset\n        const offsetX = message.offsetX || 0;\n        svgShape.x =\n          penpot.viewport.center.x - (svgShape.width || 0) / 2 + offsetX;\n        svgShape.y = penpot.viewport.center.y - (svgShape.height || 0) / 2;\n\n        // Select the newly created shape\n        penpot.selection = [svgShape];\n\n        // Send success message back to UI\n        penpot.ui.sendMessage({\n          source: \"penpot\",\n          type: \"import-success\",\n        });\n      } else {\n        throw new Error(\"Failed to create SVG shape\");\n      }\n    } catch (error) {\n      console.error(\"SVG import error:\", error);\n      penpot.ui.sendMessage({\n        source: \"penpot\",\n        type: \"import-error\",\n        error: error instanceof Error ? error.message : \"Unknown error\",\n      });\n    }\n  }\n\n  // Handle PDF page import\n  if (message.type === \"import-pdf-page\") {\n    try {\n      if (!message.data) throw new Error(\"No data provided\");\n      const imageData = new Uint8Array(message.data);\n      const imageName = `PDF Page ${message.pageNum}`;\n\n      // Upload the image to Penpot\n      const imageAsset = await penpot.uploadMediaData(\n        imageName,\n        imageData,\n        \"image/png\",\n      );\n\n      if (imageAsset) {\n        // Create a rectangle to hold the image\n        const imageShape = penpot.createRectangle();\n\n        if (imageShape) {\n          // Set the image as a fill\n          imageShape.fills = [\n            {\n              fillOpacity: 1,\n              fillImage: imageAsset,\n            },\n          ];\n\n          // Set dimensions based on the PDF page\n          const width = message.width || 500;\n          const height = message.height || 500;\n          const pageNum = message.pageNum || 1;\n          imageShape.resize(width, height);\n\n          // Position the image\n          // For multiple pages, offset them vertically to avoid overlap\n          const verticalOffset = (pageNum - 1) * (height + 50);\n          imageShape.x = penpot.viewport.center.x - width / 2;\n          imageShape.y = penpot.viewport.center.y - height / 2 + verticalOffset;\n\n          // Name the shape\n          imageShape.name = imageName;\n\n          // Select the newly created shape\n          penpot.selection = [imageShape];\n        }\n      }\n    } catch (error) {\n      console.error(\"PDF import error:\", error);\n      penpot.ui.sendMessage({\n        source: \"penpot\",\n        type: \"import-error\",\n        error: error instanceof Error ? error.message : \"Unknown error\",\n      });\n    }\n  }\n\n  // Handle get selected text request\n  if (message.type === \"get-selected-text\") {\n    const selection = penpot.selection;\n\n    if (selection && selection.length > 0) {\n      const firstShape = selection[0];\n\n      // Check if it's a text shape\n      if (firstShape.type === \"text\") {\n        penpot.ui.sendMessage({\n          source: \"penpot\",\n          type: \"selected-text\",\n          text: firstShape.characters || \"\",\n          shapeId: firstShape.id,\n        });\n      } else {\n        penpot.ui.sendMessage({\n          source: \"penpot\",\n          type: \"selected-text\",\n          text: \"\",\n          shapeId: \"\",\n        });\n      }\n    } else {\n      penpot.ui.sendMessage({\n        source: \"penpot\",\n        type: \"selected-text\",\n        text: \"\",\n        shapeId: \"\",\n      });\n    }\n  }\n\n  // Handle replace text request\n  if (message.type === \"replace-text\") {\n    const selection = penpot.selection;\n\n    if (selection && selection.length > 0) {\n      const shape = selection[0];\n\n      if (shape.type === \"text\" && message.text !== undefined) {\n        shape.characters = message.text;\n      }\n    }\n  }\n\n  // Handle get selected image request\n  if (message.type === \"get-selected-image\") {\n    const selection = penpot.selection;\n    console.log(\"Get selected image request, selection:\", selection);\n\n    if (selection && selection.length > 0) {\n      const shape = selection[0];\n      console.log(\"Shape type:\", shape.type);\n      console.log(\"Shape fills:\", shape.fills);\n\n      // Check if it's a rectangle with an image fill\n      if (shape.type === \"rectangle\" && shape.fills && shape.fills.length > 0) {\n        console.log(\"Checking fills for image...\");\n        const imageFill = shape.fills.find((fill: any) => fill.fillImage);\n        console.log(\"Image fill found:\", imageFill);\n\n        if (imageFill && imageFill.fillImage) {\n          console.log(\"fillImage object:\", imageFill.fillImage);\n          console.log(\"fillImage keys:\", Object.keys(imageFill.fillImage));\n\n          const imageInfo: any = {\n            x: shape.x,\n            y: shape.y,\n            width: shape.width,\n            height: shape.height,\n            imageName: imageFill.fillImage.name,\n            imageAssetId: imageFill.fillImage.id,\n          };\n\n          // Export for preview at full quality without borders\n          try {\n            console.log(\"Exporting preview at 1.0 scale without borders...\");\n\n            // Temporarily remove strokes/borders before export\n            const originalStrokes = shape.strokes;\n            const originalBorderRadius = shape.borderRadius;\n            shape.strokes = [];\n            if (shape.borderRadius) {\n              shape.borderRadius = 0;\n            }\n\n            const exportData = await shape.export({ type: \"png\", scale: 1.0 });\n\n            // Restore original strokes/borders\n            shape.strokes = originalStrokes;\n            if (originalBorderRadius) {\n              shape.borderRadius = originalBorderRadius;\n            }\n\n            console.log(\"Preview export successful, size:\", exportData?.length);\n\n            if (exportData && exportData.length > 0) {\n              // Manual base64 encoding\n              const bytes = new Uint8Array(exportData);\n              const base64chars =\n                \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\n              let base64 = \"\";\n\n              for (let i = 0; i < bytes.length; i += 3) {\n                const byte1 = bytes[i];\n                const byte2 = i + 1 < bytes.length ? bytes[i + 1] : 0;\n                const byte3 = i + 2 < bytes.length ? bytes[i + 2] : 0;\n\n                const encoded1 = byte1 >> 2;\n                const encoded2 = ((byte1 & 3) << 4) | (byte2 >> 4);\n                const encoded3 = ((byte2 & 15) << 2) | (byte3 >> 6);\n                const encoded4 = byte3 & 63;\n\n                base64 += base64chars[encoded1];\n                base64 += base64chars[encoded2];\n                base64 += i + 1 < bytes.length ? base64chars[encoded3] : \"=\";\n                base64 += i + 2 < bytes.length ? base64chars[encoded4] : \"=\";\n              }\n\n              imageInfo.dataUrl = `data:image/png;base64,${base64}`;\n              imageInfo.previewScale = 1.0; // Tell UI this is 1.0 scale (full quality)\n              console.log(\"Preview base64 conversion successful\");\n            }\n          } catch (error) {\n            console.error(\"Preview export failed:\", error);\n          }\n\n          penpot.ui.sendMessage({\n            source: \"penpot\",\n            type: \"selected-image\",\n            imageData: imageInfo,\n            shapeId: shape.id,\n          });\n          return;\n        }\n      }\n    }\n\n    // No image found\n    console.log(\"No image found in selection\");\n    penpot.ui.sendMessage({\n      source: \"penpot\",\n      type: \"selected-image\",\n      imageData: null,\n      shapeId: null,\n    });\n  }\n\n  // Handle upload cropped image request\n  if (message.type === \"upload-cropped-image\") {\n    try {\n      const selection = penpot.selection;\n\n      if (selection && selection.length > 0) {\n        const originalShape = selection[0];\n\n        // Convert array back to Uint8Array - this is the actual cropped pixel data from canvas\n        if (!message.imageData) throw new Error(\"No image data provided\");\n        const imageData = new Uint8Array(message.imageData);\n\n        console.log(\n          \"Uploading cropped image from canvas, size:\",\n          imageData.length,\n          \"dimensions from message:\",\n          message.width,\n          \"x\",\n          message.height,\n        );\n\n        // Upload the cropped image to Penpot\n        const imageAsset = await penpot.uploadMediaData(\n          \"Cropped Image\",\n          imageData,\n          \"image/png\",\n        );\n\n        if (imageAsset) {\n          console.log(\n            \"Image asset created with dimensions:\",\n            imageAsset.width,\n            \"x\",\n            imageAsset.height,\n          );\n\n          // Create a new rectangle for the cropped image\n          const croppedShape = penpot.createRectangle();\n\n          if (croppedShape) {\n            // Get dimensions - prefer message dimensions, then asset dimensions, then original shape\n            const width =\n              message.width || imageAsset.width || originalShape.width || 100;\n            const height =\n              message.height ||\n              imageAsset.height ||\n              originalShape.height ||\n              100;\n            const originalX = message.originalX || 0;\n            const originalY = message.originalY || 0;\n\n            console.log(\"Setting cropped shape dimensions to:\", width, height);\n\n            // Position first\n            croppedShape.x = originalShape.x + originalX;\n            croppedShape.y = originalShape.y + originalY;\n\n            // Resize to match dimensions\n            croppedShape.resize(width, height);\n\n            // Set the cropped image as fill\n            croppedShape.fills = [\n              {\n                fillOpacity: 1,\n                fillImage: imageAsset,\n              },\n            ];\n\n            // Name the shape\n            croppedShape.name = \"Cropped Image\";\n\n            // Remove strokes\n            croppedShape.strokes = [];\n\n            // Lock proportions\n            croppedShape.proportionLock = true;\n\n            // Select the new shape\n            penpot.selection = [croppedShape];\n\n            console.log(\n              \"Cropped image created. Final dimensions:\",\n              croppedShape.width,\n              \"x\",\n              croppedShape.height,\n            );\n\n            penpot.ui.sendMessage({\n              source: \"penpot\",\n              type: \"crop-success\",\n            });\n          }\n        }\n      }\n    } catch (error) {\n      console.error(\"Upload cropped image error:\", error);\n      penpot.ui.sendMessage({\n        source: \"penpot\",\n        type: \"crop-error\",\n        error: error instanceof Error ? error.message : \"Unknown error\",\n      });\n    }\n  }\n\n  // Handle get image for background removal request\n  if (message.type === \"get-image-for-bg-removal\") {\n    const selection = penpot.selection;\n\n    if (selection && selection.length > 0) {\n      const shape = selection[0];\n\n      if (shape.type === \"rectangle\" && shape.fills && shape.fills.length > 0) {\n        const imageFill = shape.fills.find((fill: any) => fill.fillImage);\n\n        if (imageFill && imageFill.fillImage) {\n          try {\n            console.log(\"Exporting image for background removal...\");\n\n            // Temporarily remove strokes/borders before export\n            const originalStrokes = shape.strokes;\n            const originalBorderRadius = shape.borderRadius;\n            shape.strokes = [];\n            if (shape.borderRadius) {\n              shape.borderRadius = 0;\n            }\n\n            const exportData = await shape.export({ type: \"png\", scale: 1.0 });\n\n            // Restore original strokes/borders\n            shape.strokes = originalStrokes;\n            if (originalBorderRadius) {\n              shape.borderRadius = originalBorderRadius;\n            }\n\n            if (exportData && exportData.length > 0) {\n              // Manual base64 encoding\n              const bytes = new Uint8Array(exportData);\n              const base64chars =\n                \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\n              let base64 = \"\";\n\n              for (let i = 0; i < bytes.length; i += 3) {\n                const byte1 = bytes[i];\n                const byte2 = i + 1 < bytes.length ? bytes[i + 1] : 0;\n                const byte3 = i + 2 < bytes.length ? bytes[i + 2] : 0;\n\n                const encoded1 = byte1 >> 2;\n                const encoded2 = ((byte1 & 3) << 4) | (byte2 >> 4);\n                const encoded3 = ((byte2 & 15) << 2) | (byte3 >> 6);\n                const encoded4 = byte3 & 63;\n\n                base64 += base64chars[encoded1];\n                base64 += base64chars[encoded2];\n                base64 += i + 1 < bytes.length ? base64chars[encoded3] : \"=\";\n                base64 += i + 2 < bytes.length ? base64chars[encoded4] : \"=\";\n              }\n\n              penpot.ui.sendMessage({\n                source: \"penpot\",\n                type: \"image-for-bg-removal\",\n                imageData: `data:image/png;base64,${base64}`,\n                shapeId: shape.id,\n                width: shape.width,\n                height: shape.height,\n              });\n              return;\n            }\n          } catch (error) {\n            console.error(\"Export for bg removal failed:\", error);\n          }\n        }\n      }\n    }\n\n    // No valid image found\n    penpot.ui.sendMessage({\n      source: \"penpot\",\n      type: \"image-for-bg-removal\",\n      imageData: null,\n      shapeId: null,\n    });\n  }\n\n  // Handle upload background-removed image\n  if (message.type === \"upload-bg-removed-image\") {\n    try {\n      const selection = penpot.selection;\n\n      if (selection && selection.length > 0) {\n        const originalShape = selection[0];\n\n        // Convert array back to Uint8Array\n        if (!message.imageData) throw new Error(\"No image data provided\");\n        const imageData = new Uint8Array(message.imageData);\n\n        console.log(\n          \"Uploading background-removed image, size:\",\n          imageData.length,\n          \"dimensions:\",\n          message.width,\n          \"x\",\n          message.height,\n        );\n\n        // Upload the image to Penpot\n        const imageAsset = await penpot.uploadMediaData(\n          \"Background Removed\",\n          imageData,\n          \"image/png\",\n        );\n\n        if (imageAsset) {\n          console.log(\"Image asset created:\", imageAsset);\n          console.log(\"Image asset width:\", imageAsset.width);\n          console.log(\"Image asset height:\", imageAsset.height);\n\n          // Create a new rectangle for the image\n          const newShape = penpot.createRectangle();\n\n          if (newShape) {\n            // Get dimensions - prefer message dimensions, fall back to asset dimensions or original shape\n            const width =\n              message.width || imageAsset.width || originalShape.width || 100;\n            const height =\n              message.height ||\n              imageAsset.height ||\n              originalShape.height ||\n              100;\n\n            console.log(\n              \"Message dimensions:\",\n              message.width,\n              \"x\",\n              message.height,\n            );\n            console.log(\n              \"Asset dimensions:\",\n              imageAsset.width,\n              \"x\",\n              imageAsset.height,\n            );\n            console.log(\"Setting shape dimensions to:\", width, \"x\", height);\n\n            // Position at the same location as original\n            newShape.x = originalShape.x;\n            newShape.y = originalShape.y;\n\n            // Resize to correct dimensions\n            newShape.resize(width, height);\n\n            // Set the image as fill - DO NOT spread imageAsset, use it directly\n            newShape.fills = [\n              {\n                fillOpacity: 1,\n                fillImage: imageAsset,\n              },\n            ];\n\n            // Name the shape\n            newShape.name = \"Background Removed\";\n\n            // Remove strokes\n            newShape.strokes = [];\n\n            // Lock proportions to maintain aspect ratio\n            newShape.proportionLock = true;\n\n            console.log(\n              \"Background-removed image created. Final dimensions:\",\n              newShape.width,\n              \"x\",\n              newShape.height,\n            );\n\n            // Select the new shape\n            penpot.selection = [newShape];\n\n            console.log(\n              \"Background-removed image created with dimensions:\",\n              newShape.width,\n              \"x\",\n              newShape.height,\n            );\n\n            penpot.ui.sendMessage({\n              source: \"penpot\",\n              type: \"bg-removal-success\",\n            });\n          }\n        }\n      }\n    } catch (error) {\n      console.error(\"Upload background-removed image error:\", error);\n      penpot.ui.sendMessage({\n        source: \"penpot\",\n        type: \"bg-removal-error\",\n        error: error instanceof Error ? error.message : \"Unknown error\",\n      });\n    }\n  }\n});\n\n// Update the theme in the iframe\npenpot.on(\"themechange\", (theme) => {\n  penpot.ui.sendMessage({\n    source: \"penpot\",\n    type: \"themechange\",\n    theme,\n  });\n});\n"],"names":["getSelectionContext","selection","colors","shapes","hasText","hasFills","hasStrokes","strokeCount","fillCount","minX","minY","maxX","maxY","shape","fill","stroke","context","hasSelection","width","height","svg","message","svgContent","svgShape","offsetX","error","imageData","imageName","imageAsset","imageShape","pageNum","verticalOffset","firstShape","imageFill","imageInfo","originalStrokes","originalBorderRadius","exportData","bytes","base64chars","base64","i","byte1","byte2","byte3","encoded1","encoded2","encoded3","encoded4","originalShape","croppedShape","originalX","originalY","newShape","theme"],"mappings":"yBAAA,OAAO,GAAG,KAAK,qBAAsB,mCAAoC,CACvE,MAAO,IACP,OAAQ,GACV,CAAC,EAGD,SAASA,GAKP,CACA,MAAMC,EAAY,OAAO,UAEzB,GAAI,CAACA,GAAaA,EAAU,SAAW,EACrC,MAAO,CAAE,QAAS,GAAI,MAAO,IAAK,OAAQ,IAAK,IAAK,EAAA,EAGtD,MAAMC,MAAa,IACbC,EAAmB,CAAA,EACzB,IAAIC,EAAU,GACVC,EAAW,GACXC,EAAa,GACbC,EAAc,EACdC,EAAY,EACZC,EAAO,IACTC,EAAO,IACPC,EAAO,KACPC,EAAO,KAETX,EAAU,QAASY,GAAU,CAGzBA,EAAM,IAAM,QACZA,EAAM,IAAM,QACZA,EAAM,OACNA,EAAM,SAENJ,EAAO,KAAK,IAAIA,EAAMI,EAAM,CAAC,EAC7BH,EAAO,KAAK,IAAIA,EAAMG,EAAM,CAAC,EAC7BF,EAAO,KAAK,IAAIA,EAAME,EAAM,EAAIA,EAAM,KAAK,EAC3CD,EAAO,KAAK,IAAIA,EAAMC,EAAM,EAAIA,EAAM,MAAM,GAI1CA,EAAM,OAAS,MAAM,QAAQA,EAAM,KAAK,GAC1CA,EAAM,MAAM,QAASC,GAAc,CAC7BA,EAAK,YACPZ,EAAO,IAAIY,EAAK,SAAS,EACzBT,EAAW,GACXG,IAEJ,CAAC,EAECK,EAAM,SAAW,MAAM,QAAQA,EAAM,OAAO,GAC9CA,EAAM,QAAQ,QAASE,GAAgB,CACjCA,EAAO,cACTb,EAAO,IAAIa,EAAO,WAAW,EAC7BT,EAAa,GACbC,IAEJ,CAAC,EAICM,EAAM,OAAS,OACjBT,EAAU,GACDS,EAAM,OAAS,YACxBV,EAAO,KAAK,YAAY,EACfU,EAAM,OAAS,UACxBV,EAAO,KAAK,kBAAkB,EACrBU,EAAM,OAAS,QACxBV,EAAO,KAAK,cAAc,CAE9B,CAAC,EAED,IAAIa,EAAU,GACd,MAAMC,EAAehB,EAAU,OAAS,EAExC,QAAQ,IAAI,sBAAuB,CACjC,eAAgBA,EAAU,OAC1B,WAAAK,EACA,SAAAD,EACA,YAAAE,EACA,UAAAC,EACA,YAAaN,EAAO,KACpB,YAAaC,EAAO,MAAA,CACrB,EAGGc,IACEX,GAAc,CAACD,EACjBW,GACE,8GACO,CAACV,GAAcD,EACxBW,GAAW,oDACFT,EAAcC,EAAY,EACnCQ,GACE,kFACO,CAACV,GAAc,CAACD,GAAYF,EAAO,OAAS,IAErDa,GACE,qHAIFd,EAAO,KAAO,IAChBc,GAAW,qBAAqB,MAAM,KAAKd,CAAM,EAAE,KAAK,IAAI,CAAC,MAG3DC,EAAO,OAAS,IAClBa,GAAW,mCAAmC,CAAC,GAAG,IAAI,IAAIb,CAAM,CAAC,EAAE,KAAK,IAAI,CAAC,MAG3EC,IACFY,GAAW,yCAITC,GAAgB,CAACD,IACnBA,EAAU,GAAGf,EAAU,MAAM,WAAWA,EAAU,OAAS,EAAI,IAAM,EAAE,eAIzE,MAAMiB,EAAQP,EAAOF,EAAO,KAAK,MAAME,EAAOF,CAAI,EAAI,IAChDU,EAASP,EAAOF,EAAO,KAAK,MAAME,EAAOF,CAAI,EAAI,IAOvD,MAAO,CAAE,QAAAM,EAAS,MAAAE,EAAO,OAAAC,EAAQ,IAJvB,EAIuB,CACnC,CAGA,OAAO,GAAG,kBAAmB,IAAM,CACjC,KAAM,CAAE,QAAAH,EAAS,MAAAE,EAAO,OAAAC,EAAQ,IAAAC,CAAA,EAAQpB,EAAA,EACxC,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,oBACN,QAAAgB,EACA,MAAAE,EACA,OAAAC,EACA,IAAAC,CAAA,CACD,CACH,CAAC,EAGD,WAAW,IAAM,CACf,KAAM,CAAE,QAAAJ,EAAS,MAAAE,EAAO,OAAAC,EAAQ,IAAAC,CAAA,EAAQpB,EAAA,EACxC,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,oBACN,QAAAgB,EACA,MAAAE,EACA,OAAAC,EACA,IAAAC,CAAA,CACD,CACH,EAAG,GAAG,EA0BN,OAAO,GAAG,UAAyB,MAAOC,GAAY,CACpD,GAAIA,EAAQ,OAAS,cAAgBA,EAAQ,OAAS,aACpD,GAAI,CACF,MAAMC,EAAaD,EAAQ,KAAOA,EAAQ,QAC1C,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,yBAAyB,EAI3C,MAAMC,EAAW,OAAO,mBAAmBD,CAAU,EAErD,GAAIC,EAAU,CAEZ,MAAMC,EAAUH,EAAQ,SAAW,EACnCE,EAAS,EACP,OAAO,SAAS,OAAO,GAAKA,EAAS,OAAS,GAAK,EAAIC,EACzDD,EAAS,EAAI,OAAO,SAAS,OAAO,GAAKA,EAAS,QAAU,GAAK,EAGjE,OAAO,UAAY,CAACA,CAAQ,EAG5B,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,gBAAA,CACP,CACH,KACE,OAAM,IAAI,MAAM,4BAA4B,CAEhD,OAASE,EAAO,CACd,QAAQ,MAAM,oBAAqBA,CAAK,EACxC,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,eACN,MAAOA,aAAiB,MAAQA,EAAM,QAAU,eAAA,CACjD,CACH,CAIF,GAAIJ,EAAQ,OAAS,kBACnB,GAAI,CACF,GAAI,CAACA,EAAQ,KAAM,MAAM,IAAI,MAAM,kBAAkB,EACrD,MAAMK,EAAY,IAAI,WAAWL,EAAQ,IAAI,EACvCM,EAAY,YAAYN,EAAQ,OAAO,GAGvCO,EAAa,MAAM,OAAO,gBAC9BD,EACAD,EACA,WAAA,EAGF,GAAIE,EAAY,CAEd,MAAMC,EAAa,OAAO,gBAAA,EAE1B,GAAIA,EAAY,CAEdA,EAAW,MAAQ,CACjB,CACE,YAAa,EACb,UAAWD,CAAA,CACb,EAIF,MAAMV,EAAQG,EAAQ,OAAS,IACzBF,EAASE,EAAQ,QAAU,IAC3BS,EAAUT,EAAQ,SAAW,EACnCQ,EAAW,OAAOX,EAAOC,CAAM,EAI/B,MAAMY,GAAkBD,EAAU,IAAMX,EAAS,IACjDU,EAAW,EAAI,OAAO,SAAS,OAAO,EAAIX,EAAQ,EAClDW,EAAW,EAAI,OAAO,SAAS,OAAO,EAAIV,EAAS,EAAIY,EAGvDF,EAAW,KAAOF,EAGlB,OAAO,UAAY,CAACE,CAAU,CAChC,CACF,CACF,OAASJ,EAAO,CACd,QAAQ,MAAM,oBAAqBA,CAAK,EACxC,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,eACN,MAAOA,aAAiB,MAAQA,EAAM,QAAU,eAAA,CACjD,CACH,CAIF,GAAIJ,EAAQ,OAAS,oBAAqB,CACxC,MAAMpB,EAAY,OAAO,UAEzB,GAAIA,GAAaA,EAAU,OAAS,EAAG,CACrC,MAAM+B,EAAa/B,EAAU,CAAC,EAG1B+B,EAAW,OAAS,OACtB,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,gBACN,KAAMA,EAAW,YAAc,GAC/B,QAASA,EAAW,EAAA,CACrB,EAED,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,gBACN,KAAM,GACN,QAAS,EAAA,CACV,CAEL,MACE,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,gBACN,KAAM,GACN,QAAS,EAAA,CACV,CAEL,CAGA,GAAIX,EAAQ,OAAS,eAAgB,CACnC,MAAMpB,EAAY,OAAO,UAEzB,GAAIA,GAAaA,EAAU,OAAS,EAAG,CACrC,MAAMY,EAAQZ,EAAU,CAAC,EAErBY,EAAM,OAAS,QAAUQ,EAAQ,OAAS,SAC5CR,EAAM,WAAaQ,EAAQ,KAE/B,CACF,CAGA,GAAIA,EAAQ,OAAS,qBAAsB,CACzC,MAAMpB,EAAY,OAAO,UAGzB,GAFA,QAAQ,IAAI,yCAA0CA,CAAS,EAE3DA,GAAaA,EAAU,OAAS,EAAG,CACrC,MAAMY,EAAQZ,EAAU,CAAC,EAKzB,GAJA,QAAQ,IAAI,cAAeY,EAAM,IAAI,EACrC,QAAQ,IAAI,eAAgBA,EAAM,KAAK,EAGnCA,EAAM,OAAS,aAAeA,EAAM,OAASA,EAAM,MAAM,OAAS,EAAG,CACvE,QAAQ,IAAI,6BAA6B,EACzC,MAAMoB,EAAYpB,EAAM,MAAM,KAAMC,GAAcA,EAAK,SAAS,EAGhE,GAFA,QAAQ,IAAI,oBAAqBmB,CAAS,EAEtCA,GAAaA,EAAU,UAAW,CACpC,QAAQ,IAAI,oBAAqBA,EAAU,SAAS,EACpD,QAAQ,IAAI,kBAAmB,OAAO,KAAKA,EAAU,SAAS,CAAC,EAE/D,MAAMC,EAAiB,CACrB,EAAGrB,EAAM,EACT,EAAGA,EAAM,EACT,MAAOA,EAAM,MACb,OAAQA,EAAM,OACd,UAAWoB,EAAU,UAAU,KAC/B,aAAcA,EAAU,UAAU,EAAA,EAIpC,GAAI,CACF,QAAQ,IAAI,mDAAmD,EAG/D,MAAME,EAAkBtB,EAAM,QACxBuB,EAAuBvB,EAAM,aACnCA,EAAM,QAAU,CAAA,EACZA,EAAM,eACRA,EAAM,aAAe,GAGvB,MAAMwB,EAAa,MAAMxB,EAAM,OAAO,CAAE,KAAM,MAAO,MAAO,EAAK,EAUjE,GAPAA,EAAM,QAAUsB,EACZC,IACFvB,EAAM,aAAeuB,GAGvB,QAAQ,IAAI,mCAAoCC,GAAY,MAAM,EAE9DA,GAAcA,EAAW,OAAS,EAAG,CAEvC,MAAMC,EAAQ,IAAI,WAAWD,CAAU,EACjCE,EACJ,mEACF,IAAIC,EAAS,GAEb,QAASC,EAAI,EAAGA,EAAIH,EAAM,OAAQG,GAAK,EAAG,CACxC,MAAMC,EAAQJ,EAAMG,CAAC,EACfE,EAAQF,EAAI,EAAIH,EAAM,OAASA,EAAMG,EAAI,CAAC,EAAI,EAC9CG,EAAQH,EAAI,EAAIH,EAAM,OAASA,EAAMG,EAAI,CAAC,EAAI,EAE9CI,EAAWH,GAAS,EACpBI,GAAaJ,EAAQ,IAAM,EAAMC,GAAS,EAC1CI,GAAaJ,EAAQ,KAAO,EAAMC,GAAS,EAC3CI,EAAWJ,EAAQ,GAEzBJ,GAAUD,EAAYM,CAAQ,EAC9BL,GAAUD,EAAYO,CAAQ,EAC9BN,GAAUC,EAAI,EAAIH,EAAM,OAASC,EAAYQ,CAAQ,EAAI,IACzDP,GAAUC,EAAI,EAAIH,EAAM,OAASC,EAAYS,CAAQ,EAAI,GAC3D,CAEAd,EAAU,QAAU,yBAAyBM,CAAM,GACnDN,EAAU,aAAe,EACzB,QAAQ,IAAI,sCAAsC,CACpD,CACF,OAAST,EAAO,CACd,QAAQ,MAAM,yBAA0BA,CAAK,CAC/C,CAEA,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,iBACN,UAAWS,EACX,QAASrB,EAAM,EAAA,CAChB,EACD,MACF,CACF,CACF,CAGA,QAAQ,IAAI,6BAA6B,EACzC,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,iBACN,UAAW,KACX,QAAS,IAAA,CACV,CACH,CAGA,GAAIQ,EAAQ,OAAS,uBACnB,GAAI,CACF,MAAMpB,EAAY,OAAO,UAEzB,GAAIA,GAAaA,EAAU,OAAS,EAAG,CACrC,MAAMgD,EAAgBhD,EAAU,CAAC,EAGjC,GAAI,CAACoB,EAAQ,UAAW,MAAM,IAAI,MAAM,wBAAwB,EAChE,MAAMK,EAAY,IAAI,WAAWL,EAAQ,SAAS,EAElD,QAAQ,IACN,6CACAK,EAAU,OACV,2BACAL,EAAQ,MACR,IACAA,EAAQ,MAAA,EAIV,MAAMO,EAAa,MAAM,OAAO,gBAC9B,gBACAF,EACA,WAAA,EAGF,GAAIE,EAAY,CACd,QAAQ,IACN,uCACAA,EAAW,MACX,IACAA,EAAW,MAAA,EAIb,MAAMsB,EAAe,OAAO,gBAAA,EAE5B,GAAIA,EAAc,CAEhB,MAAMhC,EACJG,EAAQ,OAASO,EAAW,OAASqB,EAAc,OAAS,IACxD9B,EACJE,EAAQ,QACRO,EAAW,QACXqB,EAAc,QACd,IACIE,EAAY9B,EAAQ,WAAa,EACjC+B,EAAY/B,EAAQ,WAAa,EAEvC,QAAQ,IAAI,uCAAwCH,EAAOC,CAAM,EAGjE+B,EAAa,EAAID,EAAc,EAAIE,EACnCD,EAAa,EAAID,EAAc,EAAIG,EAGnCF,EAAa,OAAOhC,EAAOC,CAAM,EAGjC+B,EAAa,MAAQ,CACnB,CACE,YAAa,EACb,UAAWtB,CAAA,CACb,EAIFsB,EAAa,KAAO,gBAGpBA,EAAa,QAAU,CAAA,EAGvBA,EAAa,eAAiB,GAG9B,OAAO,UAAY,CAACA,CAAY,EAEhC,QAAQ,IACN,2CACAA,EAAa,MACb,IACAA,EAAa,MAAA,EAGf,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,cAAA,CACP,CACH,CACF,CACF,CACF,OAASzB,EAAO,CACd,QAAQ,MAAM,8BAA+BA,CAAK,EAClD,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,aACN,MAAOA,aAAiB,MAAQA,EAAM,QAAU,eAAA,CACjD,CACH,CAIF,GAAIJ,EAAQ,OAAS,2BAA4B,CAC/C,MAAMpB,EAAY,OAAO,UAEzB,GAAIA,GAAaA,EAAU,OAAS,EAAG,CACrC,MAAMY,EAAQZ,EAAU,CAAC,EAEzB,GAAIY,EAAM,OAAS,aAAeA,EAAM,OAASA,EAAM,MAAM,OAAS,EAAG,CACvE,MAAMoB,EAAYpB,EAAM,MAAM,KAAMC,GAAcA,EAAK,SAAS,EAEhE,GAAImB,GAAaA,EAAU,UACzB,GAAI,CACF,QAAQ,IAAI,2CAA2C,EAGvD,MAAME,EAAkBtB,EAAM,QACxBuB,EAAuBvB,EAAM,aACnCA,EAAM,QAAU,CAAA,EACZA,EAAM,eACRA,EAAM,aAAe,GAGvB,MAAMwB,EAAa,MAAMxB,EAAM,OAAO,CAAE,KAAM,MAAO,MAAO,EAAK,EAQjE,GALAA,EAAM,QAAUsB,EACZC,IACFvB,EAAM,aAAeuB,GAGnBC,GAAcA,EAAW,OAAS,EAAG,CAEvC,MAAMC,EAAQ,IAAI,WAAWD,CAAU,EACjCE,EACJ,mEACF,IAAIC,EAAS,GAEb,QAASC,EAAI,EAAGA,EAAIH,EAAM,OAAQG,GAAK,EAAG,CACxC,MAAMC,EAAQJ,EAAMG,CAAC,EACfE,EAAQF,EAAI,EAAIH,EAAM,OAASA,EAAMG,EAAI,CAAC,EAAI,EAC9CG,EAAQH,EAAI,EAAIH,EAAM,OAASA,EAAMG,EAAI,CAAC,EAAI,EAE9CI,EAAWH,GAAS,EACpBI,GAAaJ,EAAQ,IAAM,EAAMC,GAAS,EAC1CI,GAAaJ,EAAQ,KAAO,EAAMC,GAAS,EAC3CI,EAAWJ,EAAQ,GAEzBJ,GAAUD,EAAYM,CAAQ,EAC9BL,GAAUD,EAAYO,CAAQ,EAC9BN,GAAUC,EAAI,EAAIH,EAAM,OAASC,EAAYQ,CAAQ,EAAI,IACzDP,GAAUC,EAAI,EAAIH,EAAM,OAASC,EAAYS,CAAQ,EAAI,GAC3D,CAEA,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,uBACN,UAAW,yBAAyBR,CAAM,GAC1C,QAAS3B,EAAM,GACf,MAAOA,EAAM,MACb,OAAQA,EAAM,MAAA,CACf,EACD,MACF,CACF,OAASY,EAAO,CACd,QAAQ,MAAM,gCAAiCA,CAAK,CACtD,CAEJ,CACF,CAGA,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,uBACN,UAAW,KACX,QAAS,IAAA,CACV,CACH,CAGA,GAAIJ,EAAQ,OAAS,0BACnB,GAAI,CACF,MAAMpB,EAAY,OAAO,UAEzB,GAAIA,GAAaA,EAAU,OAAS,EAAG,CACrC,MAAMgD,EAAgBhD,EAAU,CAAC,EAGjC,GAAI,CAACoB,EAAQ,UAAW,MAAM,IAAI,MAAM,wBAAwB,EAChE,MAAMK,EAAY,IAAI,WAAWL,EAAQ,SAAS,EAElD,QAAQ,IACN,4CACAK,EAAU,OACV,cACAL,EAAQ,MACR,IACAA,EAAQ,MAAA,EAIV,MAAMO,EAAa,MAAM,OAAO,gBAC9B,qBACAF,EACA,WAAA,EAGF,GAAIE,EAAY,CACd,QAAQ,IAAI,uBAAwBA,CAAU,EAC9C,QAAQ,IAAI,qBAAsBA,EAAW,KAAK,EAClD,QAAQ,IAAI,sBAAuBA,EAAW,MAAM,EAGpD,MAAMyB,EAAW,OAAO,gBAAA,EAExB,GAAIA,EAAU,CAEZ,MAAMnC,EACJG,EAAQ,OAASO,EAAW,OAASqB,EAAc,OAAS,IACxD9B,EACJE,EAAQ,QACRO,EAAW,QACXqB,EAAc,QACd,IAEF,QAAQ,IACN,sBACA5B,EAAQ,MACR,IACAA,EAAQ,MAAA,EAEV,QAAQ,IACN,oBACAO,EAAW,MACX,IACAA,EAAW,MAAA,EAEb,QAAQ,IAAI,+BAAgCV,EAAO,IAAKC,CAAM,EAG9DkC,EAAS,EAAIJ,EAAc,EAC3BI,EAAS,EAAIJ,EAAc,EAG3BI,EAAS,OAAOnC,EAAOC,CAAM,EAG7BkC,EAAS,MAAQ,CACf,CACE,YAAa,EACb,UAAWzB,CAAA,CACb,EAIFyB,EAAS,KAAO,qBAGhBA,EAAS,QAAU,CAAA,EAGnBA,EAAS,eAAiB,GAE1B,QAAQ,IACN,sDACAA,EAAS,MACT,IACAA,EAAS,MAAA,EAIX,OAAO,UAAY,CAACA,CAAQ,EAE5B,QAAQ,IACN,oDACAA,EAAS,MACT,IACAA,EAAS,MAAA,EAGX,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,oBAAA,CACP,CACH,CACF,CACF,CACF,OAAS5B,EAAO,CACd,QAAQ,MAAM,yCAA0CA,CAAK,EAC7D,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,mBACN,MAAOA,aAAiB,MAAQA,EAAM,QAAU,eAAA,CACjD,CACH,CAEJ,CAAC,EAGD,OAAO,GAAG,cAAgB6B,GAAU,CAClC,OAAO,GAAG,YAAY,CACpB,OAAQ,SACR,KAAM,cACN,MAAAA,CAAA,CACD,CACH,CAAC"}